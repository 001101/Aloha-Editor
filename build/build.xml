<?xml version = '1.0'?>
<!DOCTYPE project> 
<project name="Aloha Builder" default="all">
	<!-- Define some properties we use in our build process -->
	<property file="build.properties" />
	<property name="srcdir" 						value="../WebContent/" />
	<property name="srcdir.examples" 				value="${srcdir}/examples" />
	<property name="testdir" 						value="../test/" />
	<property name="filename" 						value="aloha" />
	<property name="outdir" 						value="out" />
	<property name="includesdir" 					value="includes" />
	<property name="zipdir" 						value="out" />
	<property name="depsdir" 						value="deps" />
	<property name="packagedir" 					value="${outdir}/aloha-${version}" />
	<property name="compiler.yui" 					value="${depsdir}/yuicompressor-2.4.2.jar" />
	<property name="compiler.closure" 				value="${depsdir}/closure.jar" />
	
	<!-- Define the output directories -->
	<property name="outdirs.uncompressed" 			value="${packagedir}/uncompressed" />
	<property name="outdirs.compressed" 			value="${packagedir}/aloha" />
	<property name="outdirs.examples" 				value="${packagedir}/examples" />
	
	<!-- Define the files for the includes (they are listed within the following files) -->
	<property name="includes.core.js.filename" 		value="core-js.txt"/>
	<property name="includes.deps.js.filename" 		value="deps-js.txt"/>
	<property name="includes.plugins.js.filename" 	value="plugins-js.txt"/>
	<property name="includes.core.css.filename" 	value="core-css.txt"/>
	<property name="includes.deps.css.filename" 	value="deps-css.txt"/>
	<property name="includes.plugins.css.filename" 	value="plugins-css.txt"/>
	
	<!-- Define the files for generation -->
	<property name="outfiles.core.js.filename" 		value="${filename}-core.js"/>
	<property name="outfiles.deps.js.filename" 		value="${filename}-deps.js"/>
	<property name="outfiles.plugins.js.filename" 	value="${filename}-plugins.js"/>
	<property name="outfiles.all.js.filename" 		value="${filename}.js"/>
	<property name="outfiles.core.css.filename" 	value="${filename}-core.css"/>
	<property name="outfiles.deps.css.filename" 	value="${filename}-deps.css"/>
	<property name="outfiles.plugins.css.filename" 	value="${filename}-plugins.css"/>
	<property name="outfiles.all.css.filename" 		value="${filename}.css"/>
	
	<!-- Define the java executable used for compilers -->
	<property name="java" value="${java.home}${file.separator}bin${file.separator}java" />
	<path id="minify.classpath">
		<fileset dir="deps">
			<include name="**/*.jar" />
		</fileset>
	</path>
	<tstamp>
		<format property="now" pattern="yyyy-MM-dd HH:mm:ss" locale="en,UK"/>
	</tstamp>
	
	<!-- Clean the output directories and files -->
	<target name="clean">
		<delete dir="${outdir}" />
		<delete dir="${zipdir}" />
	</target>

	<!-- Create the output directories -->
	<target name="makedirs">
		<mkdir dir="${outdirs.uncompressed}" />
		<mkdir dir="${outdirs.compressed}" />
	</target>

	<!-- This target is called with parameters includefile (called later, this is merely a function) -->
	<target name="prepare_includes" depends="makedirs">
		<copy file="${includesdir}/${includefile}" todir="${outdir}" overwrite="true"/>
		<fixcrlf file="${outdir}/${includefile}" eol="unix"/>
		<replaceregexp file="${outdir}/${includefile}" flags="gm" match="\n" replace=" "/>
	</target>
	
	<!-- Copys a directory - params [to] and [folder] -->
	<target name="copydir">
		<mkdir dir="${to}/${folder}" />
		<copy todir="${to}/${folder}">
			<fileset dir="${srcdir}/${folder}" />
		</copy>
	</target>
	
	<!-- Create the include.js file - This is used for dev purposes, not production purposes, so as such; IT IS STILL NEEDED
		 We don't care for plugins in the include.js -->
	<target name="build-dev-include" depends="makedirs">
		<!-- this sets the property for the inclusion of a js file -->
		<loadfile property="dev.includejs.subst" srcfile="deps/includejs-substitution.txt"/>
		<!-- this sets the property for the inclusion of a css file -->
		<loadfile property="dev.includecss.subst" srcfile="deps/includecss-substitution.txt"/>
		
		<!-- first the deps -->
		<copy file="${outfiles.deps.filename}" todir="${outdir}" overwrite="true"/>
		<replaceregexp byline="true" file="${outdir}/${outfiles.deps.filename}" match="(.+)" replace="${dev.includejs.subst}"/>

		<!-- now aloha core -->
		<copy file="${outfiles.core.filename}" todir="${outdir}" overwrite="true"/>
		<replaceregexp byline="true" file="${outdir}/${outfiles.core.filename}" match="(.+)" replace="${dev.includejs.subst}"/>

		<!-- and the css includes -->
		<copy file="${outfiles.css.filename}" todir="${outdir}" overwrite="true"/>
		<replaceregexp byline="true" file="${outdir}/${outfiles.css.filename}" match="(.+)" replace="${dev.includecss.subst}"/>

		<!-- now concat the js files -->
		<concat destfile="${srcdir}/core/include.js" force="true">
			<fileset file="deps/includejs-header.txt"/>
			<filelist dir="${outdir}" files="${outfiles.deps.filename},${outfiles.core.filename}"></filelist>
			<fileset file="deps/includejs-footer.txt"/>
		</concat>

		<!-- and the css file -->
		<concat destfile="${srcdir}/core/css.js" force="true">
			<fileset file="deps/includecss-header.txt"/>
			<filelist dir="${outdir}" files="${outfiles.css.filename}"></filelist>
			<fileset file="deps/includecss-footer.txt"/>
		</concat>
		
		<!--
			replace everything for the testloader
		-->
		
		<!-- this sets the property for the inclusion of a js file -->
		<loadfile property="testloader.includejs.subst" srcfile="${testdir}includejs-substitution.txt"/>
		<!-- this sets the property for the inclusion of a css file -->
		<loadfile property="testloader.includecss.subst" srcfile="${testdir}includecss-substitution.txt"/>
		
		<!-- first the deps -->
		<copy file="${outfiles.deps.filename}" todir="${outdir}" overwrite="true"/>
		<replaceregexp byline="true" file="${outdir}/${outfiles.deps.filename}" match="(.+)" replace="${testloader.includejs.subst}"/>

		<!-- now aloha core -->
		<copy file="${outfiles.core.filename}" todir="${outdir}" overwrite="true"/>
		<replaceregexp byline="true" file="${outdir}/${outfiles.core.filename}" match="(.+)" replace="${testloader.includejs.subst}"/>

		<!-- and the css includes -->
		<copy file="${outfiles.css.filename}" todir="${outdir}" overwrite="true"/>
		<replaceregexp byline="true" file="${outdir}/${outfiles.css.filename}" match="(.+)" replace="${testloader.includecss.subst}"/>

		<!-- now concat all files into the testloader -->
		<concat destfile="${testdir}testloader.html" force="true">
			<filelist dir="${outdir}" files="${outfiles.css.filename},${outfiles.deps.filename},${outfiles.core.filename}"></filelist>
		</concat>
	</target>
	
	<!-- Prepare the Uncompressed Directory -->
	<target name="prepareuncompressed" depends="makedirs">
		<!-- Copy the Necessary Dirs/Files to the Uncompressed Dir -->
		<antcall target="copydir">
			<param name="folder" value="deps"/>
			<param name="to" value="${outdirs.uncompressed}"/>
		</antcall>
		<antcall target="copydir">
			<param name="folder" value="css"/>
			<param name="to" value="${outdirs.uncompressed}"/>
		</antcall>
		<antcall target="copydir">
			<param name="folder" value="images"/>
			<param name="to" value="${outdirs.uncompressed}"/>
		</antcall>
		<antcall target="copydir">
			<param name="folder" value="i18n"/>
			<param name="to" value="${outdirs.uncompressed}"/>
		</antcall>
		<antcall target="copydir">
			<param name="folder" value="plugins"/>
			<param name="to" value="${outdirs.uncompressed}"/>
		</antcall>
	</target>
	
	<!-- Combine JS Files -->
	<target name="combine-js" depends="prepareuncompressed">
		<!-- Load the Core File List -->
		<antcall target="prepare_includes">
			<param name="includefile" value="${includes.core.js.filename}"/>
		</antcall>
		<loadfile property="includes.core.js.list" srcfile="${outdir}/${includes.core.js.filename}"/>
		
		<!-- Load the Deps File List -->
		<antcall target="prepare_includes">
			<param name="includefile" value="${includes.deps.js.filename}"/>
		</antcall>
		<loadfile property="includes.deps.js.list" srcfile="${outdir}/${includes.deps.js.filename}"/>
		
		<!-- Load the Plugins File List -->
		<antcall target="prepare_includes">
			<param name="includefile" value="${includes.plugins.js.filename}"/>
		</antcall>
		<loadfile property="includes.plugins.js.list" srcfile="${outdir}/${includes.plugins.js.filename}"/>
		
		<!-- 
			Create the Uncompressed Files
		-->
		
		<!-- Generate Aloha Core file -->
		<concat destfile="${outdirs.uncompressed}/${outfiles.core.js.filename}" force="no">
			<filelist dir="${srcdir}" files="${includes.core.js.list}"/>
		</concat>
		
		<!-- Generate Aloha Deps file -->
		<concat destfile="${outdirs.uncompressed}//${outfiles.deps.js.filename}" force="no">
			<filelist dir="${srcdir}" files="${includes.deps.js.list}"/>
		</concat>
	
		<!-- Generate Aloha Deps file -->
		<concat destfile="${outdirs.uncompressed}/${outfiles.plugins.js.filename}" force="no">
			<filelist dir="${srcdir}" files="${includes.plugins.js.list}"/>
		</concat>
		
		<!-- 
			Create the Combined File
		-->
		
		<!-- Find & Replace GENTICS.Aloha.version inside the Aloha Core file with the current build version -->
		<replace file="${outdirs.uncompressed}/${outfiles.core.js.filename}" token="##ALOHAVERSION##" value="${version}"/>
		
		<!-- Create a Combined File -->
		<concat destfile="${outdirs.uncompressed}/${filename}.js" force="no">
			<fileset dir="${outdirs.uncompressed}" includes="${outfiles.deps.js.filename},${outfiles.core.js.filename},${outfiles.plugins.js.filename}" />
		</concat>
	</target>
	
	<!-- Combine CSS Files -->
	<target name="combine-css" depends="prepareuncompressed">
		<!-- Load the Core File List -->
		<antcall target="prepare_includes">
			<param name="includefile" value="${includes.core.css.filename}"/>
		</antcall>
		<loadfile property="includes.core.css.list" srcfile="${outdir}/${includes.core.css.filename}"/>
		
		<!-- Load the Deps File List -->
		<antcall target="prepare_includes">
			<param name="includefile" value="${includes.deps.css.filename}"/>
		</antcall>
		<loadfile property="includes.deps.css.list" srcfile="${outdir}/${includes.deps.css.filename}"/>
		
		<!-- Load the Plugins File List -->
		<antcall target="prepare_includes">
			<param name="includefile" value="${includes.plugins.css.filename}"/>
		</antcall>
		<loadfile property="includes.plugins.css.list" srcfile="${outdir}/${includes.plugins.css.filename}"/>
		
		<!-- 
			Create the Uncompressed Files
		-->
		
		<!-- Generate Aloha Core file -->
		<concat destfile="${outdirs.uncompressed}/${outfiles.core.css.filename}" force="no">
			<filelist dir="${srcdir}" files="${includes.core.css.list}"/>
		</concat>
		
		<!-- Generate Aloha Deps file -->
		<concat destfile="${outdirs.uncompressed}//${outfiles.deps.css.filename}" force="no">
			<filelist dir="${srcdir}" files="${includes.deps.css.list}"/>
		</concat>
	
		<!-- Generate Aloha Deps file -->
		<concat destfile="${outdirs.uncompressed}/${outfiles.plugins.css.filename}" force="no">
			<filelist dir="${srcdir}" files="${includes.plugins.css.list}"/>
		</concat>
		
		<!-- 
			Create the Combined File
		-->
		
		<!-- Find & Replace GENTICS.Aloha.version inside the Aloha Core file with the current build version -->
		<replace file="${outdirs.uncompressed}/${outfiles.core.css.filename}" token="##ALOHAVERSION##" value="${version}"/>
		
		<!-- Create a Combined File -->
		<concat destfile="${outdirs.uncompressed}/${filename}.css" force="no">
			<fileset dir="${outdirs.uncompressed}" includes="${outfiles.deps.css.filename},${outfiles.core.css.filename},${outfiles.plugins.css.filename}" />
		</concat>
	</target>
	
	<!-- Prepare the Compressed Directory -->
	<target name="preparecompressed" depends="makedirs">
		<!-- Remove Javascript + CSS Files from the various folders (as we just included them) -->
		<delete>
			<fileset dir="${outdirs.uncompressed}/deps/" includes="**/*.js" />
			<fileset dir="${outdirs.uncompressed}/deps/" includes="**/*.css" />
		</delete>
		
		<!-- Copy the Necessary Dirs/Files to the Compressed Dir --> 
		<copy todir="${outdirs.compressed}">
			<fileset dir="${outdirs.uncompressed}" />
		</copy>
	</target>
	
	<!-- Compress the JS Files  -->
	<target name="compress-js" depends="preparecompressed">
		<!-- Compress Aloha Core file -->
		<java jar="${compiler.closure}" fork="true" failonerror="true" output="${outdir}/closure.log" append="true">
			<arg line="--js_output_file=${outdirs.compressed}/${outfiles.core.js.filename} --js=${outdirs.uncompressed}/${outfiles.core.js.filename}" />
			<classpath refid="minify.classpath" />
		</java>
		
		<!-- Compress Aloha Deps file -->
		<java jar="${compiler.closure}" fork="true" failonerror="true" output="${outdir}/closure.log" append="true">
			<arg line="--js_output_file=${outdirs.compressed}/${outfiles.deps.js.filename} --js=${outdirs.uncompressed}/${outfiles.deps.js.filename}" />
			<classpath refid="minify.classpath" />
		</java>
		
		<!-- Compress Aloha Plugins file -->
		<java jar="${compiler.closure}" fork="true" failonerror="true" output="${outdir}/closure.log" append="true">
			<arg line="--js_output_file=${outdirs.compressed}/${outfiles.plugins.js.filename} --js=${outdirs.uncompressed}/${outfiles.plugins.js.filename}" />
			<classpath refid="minify.classpath" />
		</java>
		
		<!-- Compress Aloha Combined file -->
		<java jar="${compiler.closure}" fork="true" failonerror="true" output="${outdir}/closure.log" append="true">
			<arg line="--js_output_file=${outdirs.compressed}/${filename}.js --js=${outdirs.uncompressed}/${filename}.js" />
			<classpath refid="minify.classpath" />
		</java>
	</target>
	
	<!-- Compress the CSS Files -->
	<target name="compress-css" depends="preparecompressed">
		<!-- Compress Aloha Core file -->
		<java jar="${compiler.yui}" fork="true" failonerror="true" output="${outdir}/yui.log" append="true">
			<arg line="--type css -o ${outdirs.compressed}/${outfiles.core.css.filename} --nomunge --verbose --charset UTF-8 ${outdirs.compressed}/${outfiles.core.css.filename}" />
			<classpath refid="minify.classpath" />
		</java>
		
		<!-- Compress Aloha Deps file -->
		<java jar="${compiler.yui}" fork="true" failonerror="true" output="${outdir}/yui.log" append="true">
			<arg line="--type css -o ${outdirs.compressed}/${outfiles.deps.css.filename} --nomunge --verbose --charset UTF-8 ${outdirs.compressed}/${outfiles.deps.css.filename}" />
			<classpath refid="minify.classpath" />
		</java>
		
		<!-- Compress Aloha Plugins file -->
		<java jar="${compiler.yui}" fork="true" failonerror="true" output="${outdir}/yui.log" append="true">
			<arg line="--type css -o ${outdirs.compressed}/${outfiles.plugins.css.filename} --nomunge --verbose --charset UTF-8 ${outdirs.compressed}/${outfiles.plugins.css.filename}" />
			<classpath refid="minify.classpath" />
		</java>
		
		<!-- Compress Aloha Combined file -->
		<java jar="${compiler.yui}" fork="true" failonerror="true" output="${outdir}/yui.log" append="true">
			<arg line="--type css -o ${outdirs.compressed}/${filename}.css --nomunge --verbose --charset UTF-8 ${outdirs.compressed}/${filename}.css" />
			<classpath refid="minify.classpath" />
		</java>
	</target>
	
	<!-- Adjust -->
	<target name="adjust">
		<!-- create the version files -->
		<copy todir="${packagedir}" file="${srcdir}/VERSION.txt"/>
		<replace file="${packagedir}/VERSION.txt" token="##ALOHABUILT##" value="${now}"/>
		<replace file="${packagedir}/VERSION.txt" token="##ALOHAVERSION##" value="${version}"/>
		<copy todir="${outdirs.compressed}" file="${packagedir}/VERSION.txt"/>
		<copy todir="${outdirs.uncompressed}" file="${packagedir}/VERSION.txt"/>
		
		<!-- copy the index file to the output and replace the versions -->
		<copy todir="${packagedir}" file="${srcdir}/index.html"/>
		<copy todir="${packagedir}" file="${srcdir}/bg.png"/>
		<copy todir="${packagedir}" file="${srcdir}/logo.gif"/>
		<replace file="${packagedir}/index.html" token="##ALOHABUILT##" value="${now}"/>
		<replace file="${packagedir}/index.html" token="##ALOHAVERSION##" value="${version}"/>

		<!--
			build the examples
		-->
		<mkdir dir="${outdirs.examples}"/>
		<copy todir="${outdirs.examples}">
			<fileset dir="${srcdir.examples}" />
		</copy>
		<!-- copy aloha to the examples -->
		<mkdir dir="${outdirs.examples}/aloha" />
		<copy todir="${outdirs.examples}/aloha">
			<fileset dir="${outdirs.compressed}" />
		</copy>
		<!-- fix the include of the main file -->
		<replaceregexp flags="g" byline="true">
			<fileset dir="${packagedir}/examples">
	            <include name="**/*.html" />
			</fileset>
			<regexp pattern="(&lt;script.*?src=&quot;)../core/include.js(&quot;.*)"/>
			<substitution expression="\1aloha/aloha.js\2"/>
		</replaceregexp>
		<!-- fix the includes of the plugins -->
		<replaceregexp flags="g" byline="true">
			<fileset dir="${packagedir}/examples">
	            <include name="**/*.html" />
			</fileset>
			<regexp pattern="(&lt;script.*?src=&quot;)../plugins/(.*?&quot;.*)"/>
			<substitution expression="\1aloha/plugins/\2"/>
		</replaceregexp>
		<replaceregexp flags="g" byline="true">
			<fileset dir="${packagedir}/examples">
	            <include name="**/*.html" />
			</fileset>
			<regexp pattern="&lt;script&gt;GENTICS_Aloha_base.*&lt;/script&gt;"/>
			<substitution expression=""/>
		</replaceregexp>
	</target>

	<target name="package" depends="adjust">
		<!-- Package the output into a ZIP File -->
		<mkdir dir="${zipdir}" />
		<zip destfile="${zipdir}/${filename}-${version}.zip" basedir="${outdir}" includes="aloha-${version}/**"/>
	</target>
	
	<!-- Build all -->
	<target name="all" depends="clean,combine-js,combine-css,compress-js,compress-css" />
</project>
